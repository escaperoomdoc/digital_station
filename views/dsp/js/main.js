const defaultRDM =  {
    "diagram": {
        "flow": {
            "start": {
                "state": "idle",
                "time": "0мин"
            },
            "engine_ready": {
                "state": "idle",
                "time": "0мин"
            },
            "route_in": {
                "state": "idle",
                "time": "0мин"
            },
            "arrival": {
                "state": "idle",
                "time": "0мин"
            },
            "documents": {
                "state": "idle",
                "time": "0мин"
            },
            "magistral": {
                "state": "idle",
                "time": "0мин"
            },
            "pressure_head": {
                "state": "idle",
                "time": "0мин"
            },
            "pressure_tail": {
                "state": "idle",
                "time": "0мин"
            },
            "brakes": {
                "state": "idle",
                "time": "0мин"
            },
            "brakes_head": {
                "state": "idle",
                "time": "0мин"
            },
            "brakes_tail": {
                "state": "idle",
                "time": "0мин"
            },
            "brakes_release": {
                "state": "idle",
                "time": "0мин"
            },
            "release_head": {
                "state": "idle",
                "time": "0мин"
            },
            "release_tail": {
                "state": "idle",
                "time": "0мин"
            },
            "vu45": {
                "state": "idle",
                "time": "0мин"
            },
            "unshoe": {
                "state": "idle",
                "time": "0мин"
            },
            "depart_ready": {
                "state": "idle",
                "time": "0мин"
            },
            "route_out": {
                "state": "idle",
                "time": "0мин"
            },
            "departure": {
                "state": "idle",
                "time": "0мин"
            },
            "accompaniment": {
                "state": "idle",
                "time": "0мин"
            },
            "finish": {
                "state": "idle",
                "time": "0мин"
            }
        }
    },
    "rdm":{
        "ms_depo": {
            "state": "free"
        },
        "ms_2n": {
            "state": "free"
        },
        "ms_m3": {
            "state": "free"
        },
        "ms_3a": {
            "state": "free"
        },
        "ms_3_5": {
            "state": "free"
        },
        "ms_5a": {
            "state": "free"
        },
        "ms_2": {
            "state": "free"
        },
        "ms_6p": {
            "state": "free"
        },
        "ms_6_8": {
            "state": "free"
        },
        "ms_8p": {
            "state": "free"
        },
        "ms_m4": {
            "state": "free"
        },
        "ms_2c": {
            "state": "free"
        },
        "ms_1n": {
            "state": "free"
        },
        "ms_m1": {
            "state": "free"
        },
        "ms_7a": {
            "state": "free"
        },
        "ms_7_9": {
            "state": "free"
        },
        "ms_9p": {
            "state": "free"
        },
        "ms_1": {
            "state": "free"
        },
        "ms_2p": {
            "state": "free"
        },
        "ms_2_4": {
            "state": "free"
        },
        "ms_4p": {
            "state": "free"
        },
        "ms_m2": {
            "state": "free"
        },
        "ms_1c": {
            "state": "free"
        },
        "ms_9m": {
            "state": "free"
        },
        "ms_5": {
            "state": "free"
        },
        "ms_2m": {
            "state": "free"
        },
        "ms_7m": {
            "state": "free"
        },
        "ms_5m": {
            "state": "free"
        },
        "ms_4m": {
            "state": "free"
        },
        "ms_6m": {
            "state": "free"
        },
        "ms_3m": {
            "state": "free"
        },
        "ms_1a": {
            "state": "free"
        },
        "ms_1p": {
            "state": "free"
        },
        "ms_3": {
            "state": "free"
        },
        "ms_12p": {
            "state": "free"
        },
        "ms_12a": {
            "state": "free"
        },
        "ms_10p": {
            "state": "free"
        },
        "ms_1m": {
            "state": "free"
        },
        "ms_4": {
            "state": "free"
        },
        "ms_12m": {
            "state": "free"
        },
        "ms_m16": {
            "state": "free"
        },
        "ms_10a": {
            "state": "free"
        },
        "ms_10m": {
            "state": "free"
        },
        "ms_8m": {
            "state": "free"
        },
        "sw_1p": {
            "state": "on"
        },
        "sw_1m": {
            "state": "off"
        },
        "sw_2p": {
            "state": "on"
        },
        "sw_2m": {
            "state": "off"
        },
        "sw_3p": {
            "state": "on"
        },
        "sw_3m": {
            "state": "off"
        },
        "sw_4p": {
            "state": "on"
        },
        "sw_4m": {
            "state": "off"
        },
        "sw_5p": {
            "state": "on"
        },
        "sw_5m": {
            "state": "off"
        },
        "sw_6p": {
            "state": "on"
        },
        "sw_6m": {
            "state": "off"
        },
        "sw_7p": {
            "state": "on"
        },
        "sw_7m": {
            "state": "off"
        },
        "sw_8p": {
            "state": "on"
        },
        "sw_8m": {
            "state": "off"
        },
        "sw_9p": {
            "state": "on"
        },
        "sw_9m": {
            "state": "off"
        },
        "sw_10p": {
            "state": "on"
        },
        "sw_10m": {
            "state": "off"
        },
        "sw_12p": {
            "state": "on"
        },
        "sw_12m": {
            "state": "off"
        },
        "ls_1n": {
            "state": "red"
        },
        "ls_2n": {
            "state": "red"
        },
        "ls_n5": {
            "state": "red"
        },
        "ls_n1": {
            "state": "red"
        },
        "ls_n2": {
            "state": "red"
        },
        "ls_n3": {
            "state": "red"
        },
        "ls_n4": {
            "state": "red"
        },
        "ls_2c": {
            "state": "red"
        },
        "ls_1c": {
            "state": "red"
        },
        "ls_c5": {
            "state": "red"
        },
        "ls_c1": {
            "state": "red"
        },
        "ls_c2": {
            "state": "red"
        },
        "ls_c3": {
            "state": "red"
        },
        "ls_c4": {
            "state": "red"
        },
        "ls_m1": {
            "state": "blue"
        },
        "ls_m3": {
            "state": "blue"
        },
        "ls_m2": {
            "state": "blue"
        },
        "ls_m4": {
            "state": "blue"
        },
        "ls_m14": {
            "state": "blue"
        },
        "ls_m16": {
            "state": "blue"
        },
    }
};
var app = new Vue({
    el: '.app',
    data: {
        event: JSON.parse(JSON.stringify(defaultRDM)),
        time: "00:00:00",
        abonents: [],
        logger: [],
        message: {
            "state": "idle",
            "time": "5",
            "text": "Текст сообщения",
            "progress": "0"
        },
        status: "Загрузка...",
    },
    methods: {
        play() {
            socket.emit('client2server', '{"command":"play"}');
        },
        pause() {
            socket.emit('client2server', '{"command":"pause"}');
        },
        complete() {
            socket.emit('client2server', '{"command":"complete"}');
        },
        timestep() {
            socket.emit('client2server', '{"command":"timestep"}');
        },
        reset() {
            socket.emit('client2server', '{"command":"reset"}');
        },
        skip() {
            counter++;
            updateElement(str[counter]);
        },
        resetOld() {
            this.event =  JSON.parse(JSON.stringify(defaultRDM));
            counter = 0;
            this.time = "00:00:00";
        },
        confirm: function () {
            socket.emit('client2server', '{"command":"complete"}');
        },
        cancel: function () {

        },
        progressBar: function() {
            if (this.message.state=='active' && (this.message.time >= 0)) {
                let progress1 = +this.message.progress;
                if (progress1 < 0) progress1 = 0;
                else if (progress1 > 100) progress1 = 100;
                let progress2 = progress1 + 5;
                let value = 'linear-gradient(to right, #7AFF90 ' + progress1 + '%, #E6FFEA ' + progress2 + '%)';
                return { background: value};
            }
        },
    }
});

var counter = 0;
var str;
function read(){
    var file = document.getElementById("file").files[0];
    var reader = new FileReader();
    reader.onload = function() {
        str = reader.result.replace(/\r?\n/g, "");
        str = JSON.parse(str);
        counter = 0;
        updateElement(str[counter]);
        //app.event=JSON.parse(reader.result);
        //document.getElementById("out").innerHTML=reader.result
    };
    reader.readAsText(file)
}

function updateModel(obj) {
    /* TIME */
    app.time = obj.timestring;

    /* FLOWCHART */
    obj.flow.forEach(function(item) {
        let name = item.name;
        let state = item.state;
        let time = item.time;
        if (time !== undefined && time !== "" && time < 0) state = "fail";

        app.event.diagram.flow[name].state = state;
        app.event.diagram.flow[name].time = time + "мин";
    });

    /* RDM */
    obj.rdm.forEach(function(item) {
        let type = item.type;
        let name = item.name;
        let param = item.param;
        let state = item.state;

        switch (type) {
            case "section": {
                switch (param) {
                    case "state": {
                        app.event.rdm[name].state = state;
                        break;
                    }
                }
                break;
            }
            case "switch": {
                switch (param) {
                    case "show": {
                        app.event.rdm[name].state = state;
                        break;
                    }
                }
                break;
            }
            case "light": {
                switch (param) {
                    case "state": {
                        app.event.rdm[name].state = state;
                        break;
                    }
                }
                break;
            }
        }
    });

    /* ABONENTS */
    app.abonents.splice(0, app.abonents.length);
    obj.abonents.forEach(function(item) {
        let name = item.name;
        app.abonents.push({"name": name});
    });

    /* LOGGER */
    app.logger.splice(0, app.logger.length);
    obj.messages.forEach(function(item) {
        let name = item.name;
        let state = item.state;
        let text = "";
        if (state === "idle") text = "В ожидании...";
        else text = item.text;
        app.logger.push({"name": name, "text": text, "state": state});
    });

    /* MESSAGE */
    obj.messages.forEach(function(item) {
        if (item.type === "dsp"){
            if ( (app.message.state !== "ready") && (item.state === "ready") ||
                (app.message.state !== "active") && (item.state === "active"))
            {
                audio.play();
            }
            app.message.state = item.state;
            app.message.time = item.time;
            app.message.text = item.text;
            app.message.progress = item.progress;
        }
    });

    /* STATUS */
    obj.stocks.forEach(function(item) {
        if (item.active) {
            app.status = item.status;
        }
    });

    //app.event.diagram.flow = JSON.parse(JSON.stringify(obj.flow));
    //app.event.rdm = JSON.parse(JSON.stringify(obj.rdm));
}

function updateElement(str) {
    let time = str.time;
    let type = str.type;
    let object = str.object;
    let param = str.param;
    let value = str.value;

    app.time = time;

    switch (type) {
        case "section": {
            switch (param) {
                case "state": {
                    app.event.rdm[object].state = value;
                    break;
                }
            }
            break;
        }
        case "switch": {
            switch (param) {
                case "show": {
                    app.event.rdm[object].state = value;
                    break;
                }
            }
            break;
        }
        case "light": {
            switch (param) {
                case "state": {
                    app.event.rdm[object].state = value;
                    break;
                }
            }
            break;
        }
    }

    //app.event.diagram.flow[object].state = value;
}